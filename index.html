<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMV Converter</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; width: 90%; max-width: 600px; }
        .drop-zone { border: 2px dashed #444; background: #2a2a2a; padding: 50px; border-radius: 10px; transition: 0.2s; cursor: pointer; }
        .drop-zone:hover { border-color: #fca311; background: #333; }
        .drop-zone.dragover { border-color: #fca311; background: #444; }
        h1 { margin-bottom: 10px; color: #fca311; }
        p { color: #aaa; margin-bottom: 20px; }
        #log { margin-top: 20px; font-family: monospace; font-size: 12px; color: #888; text-align: left; background: #111; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; display: none; }
        button { background: #fca311; color: #000; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 20px; display: none; }
        button:hover { background: #e5940e; }
        .loader { display: none; margin-top: 20px; color: #fca311; }
        .footer { margin-top: 50px; font-size: 12px; color: #555; }
        .error { color: #ff4444; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>AMV Converter</h1>
    <p>Drag & Drop your video here.</p>

    <div class="drop-zone" id="drop_zone">
        <span id="status_text">Initializing...</span>
    </div>
    <div id="error_msg" class="error"></div>

    <div class="loader" id="loader">Processing... (Do not close tab)</div>
    <div id="log"></div>
    <button id="download_btn">Download AMV</button>
    
    <div class="footer">Tool Version: v1.0.3</div>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // Core engine config
    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js' 
    });

    const dropZone = document.getElementById('drop_zone');
    const statusText = document.getElementById('status_text');
    const errorMsg = document.getElementById('error_msg');
    const logBox = document.getElementById('log');
    const downloadBtn = document.getElementById('download_btn');
    const loader = document.getElementById('loader');

    async function loadFFmpeg() {
        // SECURITY CHECK
        if (!window.crossOriginIsolated) {
            statusText.innerText = "Security Check Failed";
            errorMsg.innerHTML = "Error: 'coi-serviceworker.js' is missing or not working.<br>Refresh the page once. If this persists, ensure both files are in the GitHub folder.";
            return;
        }

        try {
            statusText.innerText = "Loading Engine...";
            await ffmpeg.load();
            statusText.innerText = "Ready. Drop video file here.";
            errorMsg.innerText = "";
        } catch (e) {
            statusText.innerText = "Engine Failed";
            errorMsg.innerText = e.message;
            console.error(e);
        }
    }

    // Drag and Drop Logic
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) processFile(files[0]);
    });

    // Click to upload
    dropZone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = (e) => { if(e.target.files.length > 0) processFile(e.target.files[0]); };
        input.click();
    });

    async function processFile(file) {
        if (!ffmpeg.isLoaded()) await loadFFmpeg();
        
        downloadBtn.style.display = 'none';
        loader.style.display = 'block';
        statusText.innerText = `Converting: ${file.name}`;
        
        try {
            ffmpeg.FS('writeFile', 'input', await fetchFile(file));

            [cite_start]// EXACT ARGUMENTS FROM YOUR .BAT FILE [cite: 1]
            await ffmpeg.run(
                '-i', 'input',
                '-vf', "scale='if(gt(a,4/3),-1,320)':'if(gt(a,4/3),240,-1)',crop=320:240,hflip",
                '-c:v', 'amv',
                '-c:a', 'adpcm_ima_amv',
                '-r', '21',
                '-ac', '1',
                '-ar', '22050',
                '-block_size', '1050',
                'output.amv'
            );

            const data = ffmpeg.FS('readFile', 'output.amv');
            
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/amv' }));
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = `${file.name.split('.')[0]}_converted.amv`;
                a.click();
            };
            
            downloadBtn.style.display = 'inline-block';
            statusText.innerText = "Conversion Complete!";
        } catch (error) {
            statusText.innerText = "Conversion Error";
            errorMsg.innerText = "Check console for details.";
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    loadFFmpeg();
</script>
</body>
</html>
