<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub AMV Converter</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 50px auto; text-align: center; background: #121212; color: white; }
        .box { border: 2px dashed #333; padding: 40px; border-radius: 20px; background: #1e1e1e; }
        button { background: #00ff88; color: black; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        button:disabled { background: #444; color: #888; }
        #log { font-family: monospace; font-size: 11px; background: black; color: #00ff00; padding: 10px; margin-top: 20px; height: 150px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>

<div class="box">
    <h2>MP4 to AMV</h2>
    <input type="file" id="uploader" accept="video/mp4">
    <br>
    <button id="convertBtn">Start Conversion</button>
    <div id="status">Ready</div>
    <div id="log"></div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const btn = document.getElementById('convertBtn');
    const logEl = document.getElementById('log');

    ffmpeg.setLogger(({ message }) => {
        logEl.innerHTML += `<div>${message}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    });

    btn.addEventListener('click', async () => {
        const file = document.getElementById('uploader').files[0];
        if (!file) return;

        btn.disabled = true;
        document.getElementById('status').innerText = "Loading Core...";

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        document.getElementById('status').innerText = "Processing...";
        ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

        // Using your specific command parameters
        await ffmpeg.run(
            '-i', 'input.mp4',
            '-vf', 'hflip,scale=320:240',
            '-c:v', 'amv',
            '-c:a', 'adpcm_ima_amv',
            '-r', '21',
            '-ac', '1',
            '-ar', '22050',
            '-block_size', '1050',
            'output.amv'
        );

        const data = ffmpeg.FS('readFile', 'output.amv');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-amv' }));
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'minimod_video.amv';
        a.click();

        document.getElementById('status').innerText = "Done!";
        btn.disabled = false;
    });
</script>
</body>
</html>
