const { createFFmpeg, fetchFile } = FFmpeg;

// We are switching to a core version that includes 'amv' support
const ffmpeg = createFFmpeg({ 
    log: true,
    corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
});

const btn = document.getElementById('convertBtn');
const logEl = document.getElementById('log');

ffmpeg.setLogger(({ message }) => {
    logEl.textContent += "> " + message + "\n";
    logEl.scrollTop = logEl.scrollHeight;
});

btn.addEventListener('click', async () => {
    const file = document.getElementById('uploader').files[0];
    if (!file) return;

    btn.disabled = true;
    try {
        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        logEl.textContent += "!! Loading Input File !!\n";
        ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

        // Use -f amv to force the format in case the extension isn't recognized
        await ffmpeg.run(
            '-i', 'input.mp4',
            '-vf', 'hflip,scale=320:240',
            '-c:v', 'amv',
            '-r', '21',
            '-c:a', 'adpcm_ima_amv',
            '-ac', '1',
            '-ar', '22050',
            '-block_size', '1050',
            '-f', 'amv', 
            'output.amv'
        );

        const data = ffmpeg.FS('readFile', 'output.amv');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-amv' }));
        const a = document.createElement('a');
        a.href = url;
        a.download = '1.amv';
        a.click();
        
        logEl.textContent += "!! Success: Download Triggered !!\n";
    } catch (e) {
        logEl.textContent += "ERROR: " + e.message + "\n";
    } finally {
        btn.disabled = false;
    }
});
