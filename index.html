<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMV Converter (Final)</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 90%; max-width: 800px; }
        .drop-zone { border: 2px dashed #fca311; background: #2a2a2a; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .drop-zone:hover { background: #333; }
        h1 { color: #fca311; }
        #log { 
            background: #000; border: 1px solid #444; color: #0f0; 
            padding: 10px; height: 300px; overflow-y: scroll; 
            white-space: pre-wrap; font-size: 11px; text-align: left; 
            display: block;
        }
        .btn { background: #fca311; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; display: none; margin-top: 10px;}
        
        /* New Status Styles */
        .status-loading { color: #aaa; }
        .status-ready { color: #0f0; font-weight: bold; }
        .status-error { color: #ff0000; font-weight: bold; font-size: 1.2em; background: #300; padding: 10px; border: 1px solid red; }
    </style>
</head>
<body>

<div class="container">
    <h1>AMV Converter</h1>
    
    <div class="drop-zone" id="drop_zone">
        <div id="status_text" class="status-loading">Loading Engine...</div>
    </div>

    <div id="log">Initializing...</div>
    <button id="download_btn" class="btn">Download Result</button>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const logBox = document.getElementById('log');
    const statusText = document.getElementById('status_text');
    const downloadBtn = document.getElementById('download_btn');

    // Setup the Engine
    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js',
        logger: ({ message }) => {
            console.log(message);
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
    });

    async function loadFFmpeg() {
        // 1. CHECK SECURITY
        if (!window.crossOriginIsolated) {
            statusText.className = "status-error";
            statusText.innerHTML = "⚠️ SECURITY ERROR ⚠️<br><br>The 'coi-serviceworker.js' file is missing or not active.<br>1. Ensure that file is in your GitHub folder.<br>2. Refresh this page twice.";
            logBox.innerHTML += `<div style="color:red">CRITICAL: SharedArrayBuffer is not available. Engine cannot start.</div>`;
            return;
        }

        // 2. LOAD ENGINE
        try {
            await ffmpeg.load();
            statusText.className = "status-ready";
            statusText.innerText = "READY. Drop Video Here.";
            logBox.innerHTML += `<div style="color:#fca311">--- Engine Loaded Successfully ---</div>`;
        } catch (e) {
            statusText.className = "status-error";
            statusText.innerText = "Engine Crash: " + e.message;
        }
    }

    const dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) processFile(files[0]);
    });

    async function processFile(file) {
        if (!ffmpeg.isLoaded()) return;
        downloadBtn.style.display = 'none';
        logBox.innerHTML = `<div style="color:#fca311">--- Starting Simulation for ${file.name} ---</div>`;
        
        try {
            ffmpeg.FS('writeFile', 'input', await fetchFile(file));

            // SIMULATION COMMAND:
            // Uses MJPEG (Video) and ADPCM_IMA_WAV (Audio) to mimic AMV
            await ffmpeg.run(
                '-i', 'input',
                '-vf', "scale='if(gt(a,4/3),-1,320)':'if(gt(a,4/3),240,-1)',crop=320:240,hflip",
                '-c:v', 'mjpeg',       
                '-q:v', '3',           
                '-c:a', 'adpcm_ima_wav', 
                '-r', '21',
                '-ac', '1',
                '-ar', '22050',
                'output.avi'
            );

            const data = ffmpeg.FS('readFile', 'output.avi');
            logBox.innerHTML += `<div style="color:#fca311">--- SUCCESS! ---</div>`;
            
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/avi' }));
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                // Rename to .amv for the player
                a.download = `${file.name.split('.')[0]}_converted.amv`;
                a.click();
            };
            downloadBtn.style.display = 'inline-block';

        } catch (error) {
            logBox.innerHTML += `<div style="color:red">--- ERROR ---</div>`;
            logBox.innerHTML += `<div style="color:red">${error.message}</div>`;
        }
    }

    loadFFmpeg();
</script>
</body>
</html>
