<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMV Video Converter</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; width: 90%; max-width: 600px; }
        .drop-zone { border: 2px dashed #444; background: #2a2a2a; padding: 50px; border-radius: 10px; transition: 0.2s; cursor: pointer; }
        .drop-zone:hover { border-color: #fca311; background: #333; }
        .drop-zone.dragover { border-color: #fca311; background: #444; }
        h1 { margin-bottom: 10px; color: #fca311; }
        p { color: #aaa; margin-bottom: 20px; }
        #log { margin-top: 20px; font-family: monospace; font-size: 12px; color: #888; text-align: left; background: #111; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; display: none; }
        button { background: #fca311; color: #000; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 20px; display: none; }
        button:hover { background: #e5940e; }
        .loader { display: none; margin-top: 20px; color: #fca311; }
    </style>
</head>
<body>

<div class="container">
    <h1>AMV Converter</h1>
    <p>Drag & Drop your video here to convert it for the custom player.</p>

    <div class="drop-zone" id="drop_zone">
        <span id="status_text">Drop video file here</span>
    </div>

    <div class="loader" id="loader">Processing... (This may take a moment)</div>
    <div id="log"></div>
    <button id="download_btn">Download Converted Video</button>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
<script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

<script>
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile } = FFmpegUtil;
    let ffmpeg = null;

    const dropZone = document.getElementById('drop_zone');
    const statusText = document.getElementById('status_text');
    const logBox = document.getElementById('log');
    const downloadBtn = document.getElementById('download_btn');
    const loader = document.getElementById('loader');

    // Initialize FFmpeg
    async function loadFFmpeg() {
        if (ffmpeg) return;
        statusText.innerText = "Loading conversion engine...";
        ffmpeg = new FFmpeg();
        
        ffmpeg.on('log', ({ message }) => {
            logBox.style.display = 'block';
            logBox.innerHTML += `> ${message}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        });

        // Load core from CDN
        await ffmpeg.load({
            coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js',
            wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.wasm'
        });
        
        statusText.innerText = "Ready. Drop video file here.";
    }

    // Handle Drag & Drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) processFile(files[0]);
    });

    dropZone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = (e) => { if(e.target.files.length > 0) processFile(e.target.files[0]); };
        input.click();
    });

    async function processFile(file) {
        if (!ffmpeg) await loadFFmpeg();
        
        downloadBtn.style.display = 'none';
        loader.style.display = 'block';
        statusText.innerText = `Converting: ${file.name}`;
        
        try {
            // Write file to memory
            await ffmpeg.writeFile('input', await fetchFile(file));

            // EXACT arguments from your CONVERT.bat
            // -vf "scale='if(gt(a,4/3),-1,320)':'if(gt(a,4/3),240,-1)',crop=320:240,hflip"
            // -c:v amv -c:a adpcm_ima_amv -r 21 -ac 1 -ar 22050 -block_size 1050
            
            const args = [
                '-i', 'input',
                '-vf', "scale='if(gt(a,4/3),-1,320)':'if(gt(a,4/3),240,-1)',crop=320:240,hflip",
                '-c:v', 'amv',
                '-c:a', 'adpcm_ima_amv',
                '-r', '21',
                '-ac', '1',
                '-ar', '22050',
                '-block_size', '1050',
                'output.amv'
            ];

            await ffmpeg.exec(args);

            // Read output
            const data = await ffmpeg.readFile('output.amv');
            
            // Create download link
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/amv' }));
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = `${file.name.split('.')[0]}_converted.amv`;
                a.click();
            };
            
            downloadBtn.style.display = 'inline-block';
            statusText.innerText = "Conversion Complete!";
        } catch (error) {
            statusText.innerText = "Error during conversion. Check logs.";
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    // Start loading immediately
    loadFFmpeg();
</script>
</body>
</html>
