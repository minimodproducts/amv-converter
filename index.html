<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple AMV Converter</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 40px; }
        .card { background: #2a2a2a; padding: 30px; border-radius: 15px; max-width: 500px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #log { background: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; height: 200px; overflow-y: auto; text-align: left; margin-top: 20px; border-radius: 5px; }
        button { background: #00ff88; color: black; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1em; }
        button:disabled { background: #555; cursor: not-allowed; }
        input { margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2>MP4 to AMV</h2>
    <input type="file" id="uploader" accept="video/mp4">
    <button id="convertBtn">Convert to 1.amv</button>
    <p id="status">Status: Ready</p>
    <div id="log">Logs will appear here...</div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // We use a specific build that is more likely to work on standard hosting
    const ffmpeg = createFFmpeg({ log: true });

    const btn = document.getElementById('convertBtn');
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    ffmpeg.setLogger(({ message }) => {
        logEl.textContent += message + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    });

    btn.addEventListener('click', async () => {
        const file = document.getElementById('uploader').files[0];
        if (!file) return;

        btn.disabled = true;
        statusEl.innerText = "Loading Engine... (May take a moment)";

        try {
            if (!ffmpeg.isLoaded()) await ffmpeg.load();

            statusEl.innerText = "Encoding... Please don't close this tab.";
            
            // Upload file to memory
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

            // Execute the specific command for your minimod
            // We use -f amv to ensure the container is forced
            await ffmpeg.run(
                '-i', 'input.mp4',
                '-vf', 'hflip,scale=320:240',
                '-c:v', 'amv',
                '-r', '21',
                '-c:a', 'adpcm_ima_amv',
                '-ac', '1',
                '-ar', '22050',
                '-f', 'amv',
                'output.amv'
            );

            statusEl.innerText = "Finished! Downloading...";
            
            const data = ffmpeg.FS('readFile', 'output.amv');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-amv' }));
            
            const a = document.createElement('a');
            a.href = url;
            a.download = '1.amv';
            a.click();
            
            statusEl.innerText = "Done!";
        } catch (e) {
            statusEl.innerText = "Error: " + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    });
</script>
</body>
</html>
