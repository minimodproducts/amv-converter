<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMV Simulator</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 90%; max-width: 800px; }
        .drop-zone { border: 2px dashed #fca311; background: #2a2a2a; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .drop-zone:hover { background: #333; }
        h1 { color: #fca311; }
        #log { 
            background: #000; border: 1px solid #444; color: #0f0; 
            padding: 10px; height: 300px; overflow-y: scroll; 
            white-space: pre-wrap; font-size: 11px; text-align: left; 
            display: block;
        }
        .error-text { color: #ff5555; font-weight: bold; }
        .btn { background: #fca311; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; display: none; margin-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h1>AMV Simulator</h1>
    <p>Uses standard MJPEG/ADPCM to emulate AMV format.</p>

    <div class="drop-zone" id="drop_zone">
        <span id="status_text">Loading Engine...</span>
    </div>

    <div id="log">Logs will appear here...</div>
    <button id="download_btn" class="btn">Download Result</button>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const logBox = document.getElementById('log');
    const statusText = document.getElementById('status_text');
    const downloadBtn = document.getElementById('download_btn');

    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js',
        logger: ({ message }) => {
            console.log(message);
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
    });

    async function loadFFmpeg() {
        if (!window.crossOriginIsolated) {
            logBox.innerHTML += `<div class="error-text">CRITICAL ERROR: Security Headers Missing.</div>`;
            return;
        }
        try {
            await ffmpeg.load();
            statusText.innerText = "Ready. Drop Video.";
            logBox.innerHTML += `<div style="color:#fca311">--- Engine Loaded Successfully ---</div>`;
        } catch (e) {
            logBox.innerHTML += `<div class="error-text">Engine Load Failed: ${e.message}</div>`;
        }
    }

    const dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) processFile(files[0]);
    });

    async function processFile(file) {
        if (!ffmpeg.isLoaded()) return;
        downloadBtn.style.display = 'none';
        logBox.innerHTML = `<div style="color:#fca311">--- Starting Simulation for ${file.name} ---</div>`;
        
        try {
            ffmpeg.FS('writeFile', 'input', await fetchFile(file));

            // THE SIMULATION COMMAND
            // 1. Video: Uses 'mjpeg' (Motion JPEG) instead of 'amv' (They are siblings)
            // 2. Audio: Uses 'adpcm_ima_wav' (Standard ADPCM) instead of 'adpcm_ima_amv'
            // 3. Format: .avi container
            await ffmpeg.run(
                '-i', 'input',
                '-vf', "scale='if(gt(a,4/3),-1,320)':'if(gt(a,4/3),240,-1)',crop=320:240,hflip",
                '-c:v', 'mjpeg',       // Changed from amv
                '-q:v', '3',           // Quality setting for mjpeg
                '-c:a', 'adpcm_ima_wav', // Changed from adpcm_ima_amv
                '-r', '21',
                '-ac', '1',
                '-ar', '22050',
                'output.avi'
            );

            const data = ffmpeg.FS('readFile', 'output.avi');
            logBox.innerHTML += `<div style="color:#fca311">--- SUCCESS! Simulation created. ---</div>`;
            
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/avi' }));
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                // Rename to .amv so the player attempts to read it
                a.download = `${file.name.split('.')[0]}_converted.amv`;
                a.click();
            };
            downloadBtn.innerText = "Download Simulated AMV";
            downloadBtn.style.display = 'inline-block';

        } catch (error) {
            logBox.innerHTML += `<div class="error-text">--- ERROR ---</div>`;
            logBox.innerHTML +=
