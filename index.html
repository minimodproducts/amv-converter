<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMV Web Tool</title>
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; }
        .card { background: #1e1e1e; max-width: 500px; margin: 40px auto; padding: 30px; border-radius: 12px; border: 1px solid #333; }
        #log { background: #000; color: #0dff00; font-family: monospace; font-size: 11px; padding: 15px; height: 200px; overflow-y: auto; text-align: left; border-radius: 6px; margin-top: 20px; white-space: pre-wrap; }
        button { background: #00ff88; color: #000; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2>MP4 to AMV (320x240)</h2>
    <p id="header-check" style="font-size: 12px; color: #aaa;">Checking security headers...</p>
    
    <input type="file" id="uploader" accept="video/mp4" style="margin: 20px 0;">
    <button id="convertBtn">Convert to AMV</button>
    
    <div id="status" style="margin-top: 15px; font-weight: bold; color: #00ff88;">Ready</div>
    <div id="log">Logs will appear here...</div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // Setup FFmpeg with clear logging
    const ffmpeg = createFFmpeg({ 
        log: true,
        mainName: 'main',
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
    });

    const btn = document.getElementById('convertBtn');
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const headerCheck = document.getElementById('header-check');

    // Security Header Check
    if (window.crossOriginIsolated) {
        headerCheck.innerHTML = "✅ Security Headers Active";
        headerCheck.style.color = "#00ff88";
    } else {
        headerCheck.innerHTML = "❌ Security Headers Missing. Please refresh (Ctrl+F5).";
        headerCheck.style.color = "#ff4444";
    }

    // Logger function
    ffmpeg.setLogger(({ message }) => {
        const div = document.createElement('div');
        div.textContent = message;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    });

    btn.addEventListener('click', async () => {
        const file = document.getElementById('uploader').files[0];
        if (!file) return alert("Select a file!");

        try {
            btn.disabled = true;
            statusEl.innerText = "Loading Engine...";

            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
            }

            statusEl.innerText = "Processing... (This takes a moment)";
            
            // Write input file
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

            // RUN COMMAND: Exactly matched to your specs
            await ffmpeg.run(
                '-i', 'input.mp4',
                '-vf', 'hflip,scale=320:240',
                '-c:v', 'amv',
                '-r', '21',
                '-c:a', 'adpcm_ima_amv',
                '-block_size', '1050',
                '-ac', '1',
                '-ar', '22050',
                'output.amv'
            );

            statusEl.innerText = "Finished!";
            
            // Download the file
            const data = ffmpeg.FS('readFile', 'output.amv');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-amv' }));
            const a = document.createElement('a');
            a.href = url;
            a.download = '1.amv';
            a.click();

        } catch (err) {
            console.error(err);
            statusEl.innerText = "Error - Check logs";
        } finally {
            btn.disabled = false;
        }
    });
</script>

</body>
</html>
