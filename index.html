<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimod MP4 to AMV Converter</title>
    
    <script src="coi-serviceworker.js"></script>
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a1a; color: #e0e0e0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #2d2d2d; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #00ff88; margin-bottom: 1.5rem; }
        input[type="file"] { margin: 20px 0; padding: 10px; background: #3d3d3d; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { background: #00ff88; color: #1a1a1a; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: transform 0.2s; width: 100%; }
        button:hover { transform: scale(1.02); background: #00cc6e; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        #status { margin-top: 20px; font-weight: bold; color: #00ff88; }
        #log { margin-top: 20px; background: #000; color: #00ff00; font-family: monospace; font-size: 11px; padding: 10px; height: 150px; overflow-y: auto; text-align: left; border-radius: 5px; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="container">
    <h1>AMV Converter</h1>
    <p>Convert MP4 to 320x240 AMV (21fps)</p>
    
    <input type="file" id="uploader" accept="video/mp4">
    <button id="convertBtn">Convert Video</button>
    
    <div id="status">Ready</div>
    <div id="log"></div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const convertBtn = document.getElementById('convertBtn');
    const status = document.getElementById('status');
    const logElement = document.getElementById('log');

    // Display logs on screen
    ffmpeg.setLogger(({ message }) => {
        const line = document.createElement('div');
        line.textContent = message;
        logElement.appendChild(line);
        logElement.scrollTop = logElement.scrollHeight;
    });

    convertBtn.addEventListener('click', async () => {
        const file = document.getElementById('uploader').files[0];
        if (!file) {
            alert("Please select an MP4 file first.");
            return;
        }

        try {
            convertBtn.disabled = true;
            status.innerText = "Loading FFmpeg Engine...";

            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
            }

            status.innerText = "Processing Video...";
            
            // 1. Write file to virtual memory
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

            // 2. Run conversion (CORRECTED COMMAND ORDER)
            // Note: -block_size is now placed after the audio codec
            await ffmpeg.run(
                '-i', 'input.mp4',
                '-vf', 'hflip,scale=320:240',
                '-c:v', 'amv',
                '-r', '21',
                '-c:a', 'adpcm_ima_amv',
                '-block_size', '1050',
                '-ac', '1',
                '-ar', '22050',
                'output.amv'
            );

            status.innerText = "Reading Finished File...";
            
            // 3. Read result and trigger download
            const data = ffmpeg.FS('readFile', 'output.amv');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-amv' }));
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted_video.amv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            status.innerText = "Success! Download started.";
        } catch (error) {
            console.error(error);
            status.innerText = "Error: See logs below.";
        } finally {
            convertBtn.disabled = false;
        }
    });
</script>

</body>
</html>
