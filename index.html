<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINI-MOD | APPLE-SCRIPT ENGINE (WEB)</title>
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --text-color: #ffffff;
            --accent: #eaba1f;
        }
        body { 
            background-color: var(--bg-color); color: var(--text-color);
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; min-height: 100vh; margin: 0; padding: 20px;
        }
        .card { 
            width: 100%; max-width: 480px; padding: 30px; 
            background: var(--card-bg); border-radius: 20px; 
            border: 1px solid #333; text-align: center; margin-top: 40px;
        }
        .logo { width: 80%; max-width: 300px; margin-bottom: 20px; }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #444; border-radius: 12px;
            padding: 40px 20px; margin: 20px 0;
            background: #1a1a1a; cursor: pointer; position: relative;
        }
        .drop-zone:hover { border-color: var(--accent); background: #222; }
        #uploader { position: absolute; width: 100%; height: 100%; top:0; left:0; opacity: 0; cursor: pointer; }
        
        /* Buttons */
        #convertBtn { 
            width: 100%; padding: 18px; background: var(--accent); 
            color: #000; border: none; border-radius: 8px; 
            font-weight: bold; font-size: 16px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
        }
        #convertBtn:disabled { background: #444; color: #888; cursor: wait; }
        
        /* Logs */
        #status { margin-top: 15px; color: var(--accent); font-weight: bold; }
        #error-log { 
            margin-top: 20px; background: #000; color: #ff5555; 
            font-family: monospace; padding: 10px; border-radius: 6px; 
            font-size: 11px; text-align: left; display: none; 
            white-space: pre-wrap; height: 100px; overflow-y: auto; border: 1px solid #555;
        }
        
        #downloadLink { display: none; margin-top: 15px; color: #fff; text-decoration: underline; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://images.squarespace-cdn.com/content/v1/6976aff0cf735c704e5548b5/6ef4889e-f464-48c2-ba0e-71004431619c/minimod_logo.png" class="logo" alt="LOGO">
    
    <div class="drop-zone">
        <div id="fileInfo">DRAG VIDEO HERE</div>
        <input type="file" id="uploader" accept="video/*">
    </div>

    <button id="convertBtn">CONVERT FILE</button>
    <div id="status">READY</div>
    <div id="error-log"></div>
    <a id="downloadLink">Download Video</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // USE SINGLE THREADED CORE (No service worker needed, highly stable)
    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js'
    });

    const uploader = document.getElementById('uploader');
    const status = document.getElementById('status');
    const convertBtn = document.getElementById('convertBtn');
    const errorLog = document.getElementById('error-log');
    const downloadLink = document.getElementById('downloadLink');
    let currentFile = null;

    uploader.addEventListener('change', () => {
        if(uploader.files[0]) {
            currentFile = uploader.files[0];
            document.getElementById('fileInfo').innerText = currentFile.name;
            document.getElementById('fileInfo').style.color = "#eaba1f";
            errorLog.style.display = 'none';
        }
    });

    convertBtn.addEventListener('click', async () => {
        if (!currentFile) return alert("Please select a file.");
        
        try {
            convertBtn.disabled = true;
            status.innerText = "LOADING ENGINE (Wait ~20s)...";
            errorLog.style.display = 'none';

            if (!ffmpeg.isLoaded()) await ffmpeg.load();

            status.innerText = "CONVERTING...";
            ffmpeg.FS('writeFile', 'input', await fetchFile(currentFile));

            // --- THE EXACT APPLESCRIPT SETTINGS ---
            // Note: I removed '-bsf:v mjpeg2jpeg' because it crashes the web engine.
            // All other settings are identical to your script.
            await ffmpeg.run(
                '-i', 'input',
                '-vf', 'scale=320:240:force_original_aspect_ratio=decrease,pad=320:240:(ow-iw)/2:(oh-ih)/2',
                '-c:v', 'mjpeg',
                '-q:v', '3',
                '-vtag', 'MJPG',            // Forces MJPEG tag for compatibility
                '-c:a', 'adpcm_ima_wav',    // Exact codec from your script
                '-ac', '1',                 // Mono
                '-ar', '22050',             // 22050Hz
                '-map_metadata', '-1',      // Strip metadata
                '-fflags', '+bitexact',     // Rigid headers
                '-flags:v', '+bitexact',
                '-f', 'avi',                // AVI Container
                '-y',
                'output.avi'
            );

            // Read output
            const data = ffmpeg.FS('readFile', 'output.avi');
            
            // Create Download
            const blob = new Blob([data.buffer], { type: 'video/avi' });
            const url = URL.createObjectURL(blob);
            
            // Use Original Name + CLEAN
            const cleanName = "CLEAN_" + currentFile.name.replace(/\.[^/.]+$/, "") + ".AVI";
            
            downloadLink.href = url;
            downloadLink.download = cleanName;
            downloadLink.innerText = "DOWNLOAD " + cleanName;
            downloadLink.style.display = "block";
            downloadLink.click(); // Auto-click download
            
            status.innerText = "DONE!";

        } catch (e) {
            console.error(e);
            status.innerText = "FAILED";
            errorLog.style.display = "block";
            // This prints the REAL error to the screen
            errorLog.innerText = "ERROR DETAILS:\n" + e.message; 
        } finally {
            convertBtn.disabled = false;
        }
    });
</script>

</body>
</html>
